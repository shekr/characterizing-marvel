<!-- Based on http://bl.ocks.org/dbuezas/9306799 example -->
<!DOCTYPE html>
<meta charset="utf-8">
<link type="text/css" rel="stylesheet" href="css/vis.css" />
<body>
<script src="http://d3js.org/d3.v3.js"></script>
<script src="js/names.js"></script>

<script>
var svg = d3.select("body")
	.append("svg");

svg.append("g")
	.attr("class", "chordsBox");
svg.append("g")
	.attr("class", "pieSliceBox");

var page = d3.select('body').node().getBoundingClientRect();

var width = 750,
    height = 750,
	radius = Math.min(width, height) / 2;

var innerPieRadius = radius*.9;
var outerTextRadius = radius*1.2;
var innerArcLineRadius = radius*.7;

var pie = d3.layout.pie()
	.sort(null)
	.value(function(d) {
		return d.value;
	});
	

var arc = d3.svg.arc()
	.outerRadius(radius)
	.innerRadius(innerPieRadius);

var textArc = d3.svg.arc()
	.innerRadius(radius)
	.outerRadius(outerTextRadius);
	
var outsideArc = d3.svg.arc()
	.outerRadius(radius)
	.innerRadius(radius);
	
var insideArc = d3.svg.arc()
	.outerRadius(innerPieRadius)
	.innerRadius(innerPieRadius);
	
var insideArcLineArc = d3.svg.arc()
	.outerRadius(innerArcLineRadius)
	.innerRadius(innerArcLineRadius);
	
var arcLine = d3.svg.line()
    .x(function(d) { return d[0] })
    .y(function(d) { return d[1]; })
    .interpolate("basis")
	.tension(.5);
	
svg.attr("transform", "translate(" + (page.width - width)/2 + "," + (page.height-height)/ 2 + ")");
svg.select('g.chordsBox').attr("transform", "translate(" + radius + ", " + radius + ")");

var key = function(d){ return d.data.label; };

var dataLength = 300;

function getData (){
	var labels = marvelNames.slice(0, dataLength);
	dataLength = labels.length;
	return labels.map(function(label){
		return { label: label, value: 1 }
	});
}

/*var matrixData = [];
function generateRandomMatrix() {	
	for (var i = 0; i < dataLength; i++) {
		var matrixRow = [];
		for (var j = 0; j < dataLength; j++) {
			if (Math.floor(Math.random()*300) == 199) {
				matrixRow[j] = .1;
			} else {
				matrixRow[j] = 0;	
			}
		}
		matrixData.push(matrixRow);
	}
}
*/
//generateRandomMatrix();

function getClassName(nameString) {
	return nameString.replace(/[ '\-()\.]+/g, "");
}

updateData(getData(), connections);

function updateData(data, connections) {
	
	/* ------- PIE SLICES -------*/
	var sliceParents = svg.select('g.pieSliceBox').selectAll("g")
		.data(pie(data), key)
		.enter()
		.append("g")
		.attr("transform", "translate(" + radius + ", " + radius + ")")
		.attr("class", function(d, i) {
			return "slice-" + getClassName(d.data.label);
		});

	sliceParents.append("path")
		.attr('d', arc)
		//.attr('title', key)
		.style("fill", function(d) { 
			var val = Math.random();
			if (val > .5)
				return '#4f649d';
			else
				return '#d72829';		
			//return  color(d.data.label); 
		
		})
		.attr("class", "slice");

	var slices = svg.selectAll('.slice');
	
	slices.on('mouseover', function(d){
		//slice and label
		d3.select(this).classed('active', true);
    	var nodeSelection = d3.select(this.parentNode);
    	nodeSelection.select(".label-box").classed('active', true);
		
		//arcs
		var arcID = nodeSelection.attr("class").replace('slice-', '');
		svg.select('g.arcGroup-' + arcID).classed('active', true);
		
	})
	
	slices.on('mouseout', function(d){
		//slice and label
		d3.select(this).classed('active', false);
    	var nodeSelection = d3.select(this.parentNode);
    	nodeSelection.select(".label-box").classed('active', false);
		
		//arcs
		var arcID = nodeSelection.attr("class").replace('slice-', '');
		svg.select('g.arcGroup-' + arcID).classed('active', false);
	})

	/* ------- TEXT LABELS -------*/
	var labelBoxes = sliceParents.append('g').classed('label-box', true);
	labelBoxes.append("text")
		.attr("transform", function(d) {
			return "translate(" + textArc.centroid(d) + ")";
		})
		.attr("text-anchor", function(d, i) {
			if (i < dataLength/2)
				return "start";	
			else
			 return "end"; 
		})
		.text(function(d) {
			return d.data.label;
		});

	labelBoxes.append("polyline")
	.attr("points", function(d) {
		return [outsideArc.centroid(d), textArc.centroid(d)];		
	})
	
	/* ----- ARCS -------*/
	//console.log(connections);
	var arcGroups = svg.select('g.chordsBox').selectAll("g")
		.data(connections)
		.enter()
		.append("g")
		.attr("class", function(d) {
			return "arcGroup-" + getClassName(d.name);
		})
		
	var arcs = arcGroups.selectAll("path")
		.data(function(d) {
			//only create paths for slices that exist in curr view
			var existingConnections = [];
			for (var j = 0; j < d.links.length; j++) {
				//console.log(svg.select('g.slice-' + getClassName(d.links[j])).size());
				if (svg.select('g.slice-' + getClassName(d.links[j])).size() > 0) {
					existingConnections.push(d.links[j]);
				}
			}
			return existingConnections;
		})
		.enter()
		.append("path")
		.attr("d", function(d) {
			var startSliceData = svg.select('g.slice-' + getClassName(d3.select(this.parentNode).datum().name)).datum();
			var endSliceData = svg.select('g.slice-'  + getClassName(d)).datum();
			var midPoint = [];
			var startPoint = insideArc.centroid(startSliceData);
			var startBuffer = insideArcLineArc.centroid(startSliceData);
			var endPoint = insideArc.centroid(endSliceData);
			midPoint[0] = (endPoint[0] + startBuffer[0])/2;
			midPoint[1] = (endPoint[1] + startBuffer[1])/2;	
			return arcLine([startPoint, startBuffer, midPoint, endPoint]);			
		})
	
};

</script>
</body>